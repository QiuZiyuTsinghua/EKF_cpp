# 车辆纵向速度估计 - 修改的3自由度模型

## 物理模型说明

本示例使用扩展卡尔曼滤波器（EKF）基于修改的3自由度车辆模型进行车速估计。该模型具有以下特点：

### 模型假设

1. **忽略风阻对车辆运动的影响**：不考虑空气阻力对车辆动力学的影响
2. **车辆在水平路面上行驶**：忽略坡度和悬架的作用
3. **车轮只受到轮胎和路面之间的轮胎力**：所有车轮具有相同的机械特性

### 状态向量

系统状态向量 `X` 包含3个变量：
```
X = [v_x, v_y, ω]
```

其中：
- `v_x`: 车辆纵向速度（车身坐标系）
- `v_y`: 车辆横向速度（车身坐标系）
- `ω`: 车辆偏航角速度

### 测量向量

系统测量向量 `Z` 包含7个变量：
```
Z = [ax, ay, ω, v_fl, v_fr, v_rl, v_rr]
```

其中：
- `ax, ay`: 车辆加速度（车身坐标系）
- `ω`: 车辆偏航角速度测量值
- `v_fl, v_fr, v_rl, v_rr`: 四个车轮的线速度

### 车辆动力学模型

车辆动力学基于3自由度模型，考虑纵向动力学、横向动力学以及偏航动力学：

1. **运动学方程**：
   - x' = v_x
   - y' = v_y
   - θ' = ω

2. **动力学方程**：
   - m·v_x' = F_x + m·v_y·ω  (忽略风阻)
   - m·v_y' = F_y - m·v_x·ω
   - I_z·ω' = M_z

其中：
- `m`: 车辆质量
- `I_z`: 车辆绕z轴的转动惯量
- `F_x`: 车辆纵向力总和
- `F_y`: 车辆横向力总和
- `M_z`: 车辆绕z轴的力矩总和

### 轮胎模型

轮胎力通过线性化的轮胎模型计算：

- 侧偏角：α = β - (l_f·ω)/v_x (前轮)
- 侧偏角：α = β + (l_r·ω)/v_x (后轮)
- 轮胎侧向力：F_y = C·α

其中：
- `β`: 车辆侧偏角
- `l_f, l_r`: 前轴和后轴到质心的距离
- `C`: 轮胎侧偏刚度

## 代码实现对应关系

```cpp
// 状态向量初始化
Eigen::VectorXd x0 = Eigen::VectorXd::Zero(stateSize);
x0 << 0.0, 0.0, 0.0, 10.0, 0.0, 0.0;  // 初始纵向速度为10 m/s
```

这里初始化了状态向量，对应[v_x, v_y, ω]。

```cpp
// 状态转移函数
next_x(0) += dt * vx;  // x位置更新
next_x(1) += dt * vy;  // y位置更新
next_x(2) += dt * omega;                               // 偏航角更新
```

这部分代码对应运动学方程，根据当前速度和角度更新车辆位置和偏航角。

```cpp
// 车辆侧偏角
double beta = atan2(vy, vx);

// 前轮侧偏角
double alpha_f = beta - lf * omega / vx;
// 后轮侧偏角
double alpha_r = beta + lr * omega / vx;

// 轮胎侧向力
double Fyf = -Cf * alpha_f;  // 前轮侧向力
double Fyr = -Cr * alpha_r;  // 后轮侧向力
```

这部分代码实现了轮胎模型，计算侧偏角和轮胎侧向力。

```cpp
// 更新速度和角速度
next_x(3) += dt * (Fx / m + omega * vy);  // vx更新
next_x(4) += dt * (Fy / m - omega * vx);  // vy更新
next_x(5) += dt * (Mz / Iz);             // ω更新
```

这部分代码对应动力学方程，更新车辆的速度和角速度。

```cpp
// 轮速计算
double v_fl = true_vx - (true_omega * track/2);  // 前左轮
double v_fr = true_vx + (true_omega * track/2);  // 前右轮
double v_rl = true_vx - (true_omega * track/2);  // 后左轮
double v_rr = true_vx + (true_omega * track/2);  // 后右轮
```

这部分代码计算了每个车轮的速度，考虑了转向带来的差异。

## 仿真场景说明

本示例仿真了一个简单的驾驶场景：
1. 车辆从10 m/s的初始速度开始直线行驶
2. 在2-4秒时进行转向操作
3. 在5-7秒时进行制动操作，减速度为2 m/s²

通过扩展卡尔曼滤波器，我们可以从带噪声的传感器数据中准确估计车辆的纵向速度。

## 结果分析

仿真结束后，程序计算并输出纵向速度估计的均方根误差(RMSE)，用于评估算法的性能。

在实际应用中，建议将数据导出并绘制估计结果与真实值的对比图，以直观地评估算法性能。
